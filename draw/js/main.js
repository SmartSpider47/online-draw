const firebaseConfig={apiKey:"AIzaSyCjaC7uuNWAiSx4KsXtcGHqrJtxCfaP_vU",authDomain:"onlinedraw-43013.firebaseapp.com",databaseURL:"https://onlinedraw-43013-default-rtdb.firebaseio.com",projectId:"onlinedraw-43013",storageBucket:"onlinedraw-43013.appspot.com",messagingSenderId:"947162335413",appId:"1:947162335413:web:ad12e9ab0ccb86938716fc"};firebase.initializeApp(firebaseConfig);var name=localStorage.getItem("ss47_odraw_user_n"),draw=localStorage.getItem("ss47_odraw_draw_n"),admin=0,can_edit=!1;async function SetEditing(){can_edit=await CanEdit()}function JsonToList(e){var t=e,n=[];for(var i in t)n.push([i,t[i]]);return n}SetEditing(),firebase.database().ref().child(draw).child("data").get().then(e=>{if(e.exists()){var t=e.val();t.creator==name&&(admin=1,UpdatePupilList(),document.getElementById("id_first_").innerHTML='\n\t\t\t\t\t\t<button class="btn btn-dark" data-toggle="modal" data-target="#pupils"><b>Участники</b></button>'),document.getElementById("id_ge_content").innerHTML=t.picture}else alert("Произошла неизвестная ошибка..")}).catch(e=>{alert("Нет подключения.."),console.error(e)});var TitleOfChoosed=document.getElementById("id_title_of_choosed"),content=document.getElementById("id_ge_content"),type="cursor",lineDrawind=!1,circleDrawind=!1,rectangleDrawind=!1,isDrawind=!1,dash_array="1 0",MouseLastX=-1,MouseLastY=-1;function UpdatePupilList(){firebase.database().ref().child(draw).child("users").get().then(e=>{if(e.exists()){for(var t=JsonToList(e.val()),n="",i=0;i<t.length;i++)if(t[i][0]!=name){var a="btn btn-danger",d="SetUser('"+t[i][0]+"', '1')";1==parseInt(t[i][1].canedit)&&(a="btn btn-success",d="SetUser('"+t[i][0]+"', '0')"),n+='<button class="'+a+'" onclick="'+d+'">'+t[i][0]+"</button><br><br>"}document.getElementById("id_pupil_list_content").innerHTML="<center>"+n+"</center>"}}).catch(e=>{console.error(e)})}function ChangedNum(e){var t=document.getElementById(e),n=t.value;""==n&&(t.value="0",n="0"),parseFloat(n)<0&&(t.value="0")}function MFX(){return 0}function MFY(){return parseInt(document.getElementById("id_main_nav").clientHeight)}function GetMouseX(){return parseInt(parseInt(window.event.clientX)+parseInt(MFX()))}function GetMouseY(){return parseInt(parseInt(window.event.clientY)-parseInt(MFY()))}function NewDashArray(){dash_array=document.getElementById("id_new_ln").value+" "+document.getElementById("id_new_il").value,document.getElementById("id_show_type").setAttribute("stroke-dasharray",dash_array)}function ABS(e){return e<0&&(e*=-1),e}function MIN(e,t){return e<t?e:t}function MAX(e,t){return e>t?e:t}function SavePicture(){firebase.database().ref().child(draw).child("data").get().then(e=>{if(e.exists()){var t=e.val();firebase.database().ref(draw+"/data").set({creator:t.creator,picture:document.getElementById("id_ge_content").innerHTML})}}).catch(e=>{console.error(e)})}async function CanEdit(){if(admin)return!0;var e=!1;return await firebase.database().ref().child(draw).child("users").child(name).get().then(t=>{t.exists()&&("1"==t.val().canedit&&(e=!0))}).catch(e=>{console.error(e)}),e}function UpdateCircle(){var e=GetMouseX(),t=GetMouseY(),n=parseFloat(ABS(e-MouseLastX)),i=parseFloat(ABS(t-MouseLastY)),a=parseFloat(MIN(e,MouseLastX))+n/2,d=parseFloat(MIN(t,MouseLastY))+i/2,r=document.getElementById("id_cur_circle");r.setAttribute("cx",a),r.setAttribute("cy",d),r.setAttribute("rx",n/2),r.setAttribute("ry",i/2)}function UpdateRectangle(){var e=GetMouseX(),t=GetMouseY(),n=MIN(e,MouseLastX),i=MIN(t,MouseLastY),a=parseFloat(ABS(e-MouseLastX)),d=parseFloat(ABS(t-MouseLastY)),r=document.getElementById("id_cur_rectangle");r.setAttribute("x",n),r.setAttribute("y",i),r.setAttribute("width",a),r.setAttribute("height",d)}async function MousePressed(){if(can_edit){var e=parseInt(GetMouseX()),t=parseInt(GetMouseY());if("point"==type){var n=document.getElementById("id_point_color").value,i=parseFloat(document.getElementById("id_point_size").value);content.innerHTML+='<circle cx="'+e+'" cy="'+t+'" r="'+i/2+'" fill="'+n+'"></circle>'}else if("line"==type){n=document.getElementById("id_line_color").value,i=parseFloat(document.getElementById("id_line_width").value);MouseLastX=parseFloat(e),MouseLastY=parseFloat(t),content.innerHTML+='<line id="id_cur_line" x1="'+e+'" y1="'+t+'" x2="'+e+'" y2="'+t+'" stroke="'+n+'" stroke-width="'+i+'" stroke-dasharray="'+dash_array+'" />',lineDrawind=!0}else if("circle"==type){var a=document.getElementById("id_circle_color").value,d=parseFloat(document.getElementById("id_circle_width").value),r=document.getElementById("id_circle_fill").value;MouseLastX=parseFloat(e),MouseLastY=parseFloat(t),content.innerHTML+='<ellipse id="id_cur_circle" cx="'+e+'" cy="'+t+'" r="0" stroke="'+a+'" stroke-width="'+d+'" stroke-dasharray="'+dash_array+'" fill="'+r+'" />',circleDrawind=!0}else if("rectangle"==type){a=document.getElementById("id_rectangle_color").value,d=parseFloat(document.getElementById("id_rectangle_width").value),r=document.getElementById("id_rectangle_fill").value;MouseLastX=parseFloat(e),MouseLastY=parseFloat(t),content.innerHTML+='<rect id="id_cur_rectangle" x="'+e+'" y="'+t+'" width="0" height="0" stroke="'+a+'" stroke-width="'+d+'" stroke-dasharray="'+dash_array+'" fill="'+r+'" />',rectangleDrawind=!0}else if("draw"==type){n=document.getElementById("id_draw_color").value,i=parseFloat(document.getElementById("id_draw_width").value);MouseLastX=parseFloat(e),MouseLastY=parseFloat(t),content.innerHTML+='<polyline id="id_cur_polyline" points="'+e+","+t+'" stroke="'+n+'" stroke-width="'+i+'" stroke-dasharray="'+dash_array+'" fill="none" />',isDrawind=!0}SavePicture()}}async function MouseMoved(){if(can_edit){var e=parseInt(GetMouseX()),t=parseInt(GetMouseY());if(lineDrawind){var n=document.getElementById("id_cur_line");n.setAttribute("x2",e),n.setAttribute("y2",t)}else if(circleDrawind)UpdateCircle();else if(rectangleDrawind)UpdateRectangle();else if(isDrawind){var i=document.getElementById("id_cur_polyline"),a=i.getAttribute("points");i.setAttribute("points",a+" "+e+","+t)}SavePicture()}}async function MouseReleased(){if(can_edit){if("line"==type)lineDrawind=!1,(e=document.getElementById("id_cur_line")).setAttribute("x2",GetMouseX()),e.setAttribute("y2",GetMouseY()),e.setAttribute("id","");else if("circle"==type){circleDrawind=!1;var e=document.getElementById("id_cur_circle");UpdateCircle(),e.setAttribute("id","")}else if("rectangle"==type){rectangleDrawind=!1;e=document.getElementById("id_cur_rectangle");UpdateRectangle(),e.setAttribute("id","")}else if("draw"==type){isDrawind=!1,(e=document.getElementById("id_cur_polyline")).setAttribute("id","")}SavePicture()}}function UpdateTools(){"cursor"==type?(document.getElementById("id_toolplace_1").innerHTML="",document.getElementById("id_toolplace_2").innerHTML="",document.getElementById("id_toolplace_3").innerHTML="",document.getElementById("id_toolplace_4").innerHTML=""):"point"==type?(document.getElementById("id_toolplace_1").innerHTML='Color<input id="id_point_color" type="color" class="css-color">',document.getElementById("id_toolplace_2").innerHTML='Size<input id="id_point_size" type="number" value="1" onchange="ChangedNum(\'id_point_size\')" class="css-number">',document.getElementById("id_toolplace_3").innerHTML="",document.getElementById("id_toolplace_4").innerHTML=""):"line"==type?(dash_array="1 0",document.getElementById("id_toolplace_1").innerHTML='Color<input id="id_line_color" type="color" class="css-color">',document.getElementById("id_toolplace_2").innerHTML='Width<input id="id_line_width" type="number" value="1" onchange="ChangedNum(\'id_line_width\')" class="css-number">',document.getElementById("id_toolplace_3").innerHTML='<button id="id_datype" class="btn-secondary css-btn-type" data-toggle="modal" data-target="#ModalChooseBorderType"><svg class="css-svg-ln"><line id="id_show_type" x1="10" y1="5" x2="290" y2="5" stroke="white" stroke-width="2" stroke-dasharray="1 0"></line></svg></button>',document.getElementById("id_toolplace_4").innerHTML=""):"circle"==type?(dash_array="1 0",document.getElementById("id_toolplace_1").innerHTML='Border Color<input id="id_circle_color" type="color" class="css-color">',document.getElementById("id_toolplace_2").innerHTML='Border Width<input id="id_circle_width" type="number" value="1" onchange="ChangedNum(\'id_circle_width\')" class="css-number">',document.getElementById("id_toolplace_3").innerHTML='<button id="id_datype" class="btn-secondary css-btn-type" data-toggle="modal" data-target="#ModalChooseBorderType"><svg class="css-svg-ln"><line id="id_show_type" x1="10" y1="5" x2="290" y2="5" stroke="white" stroke-width="2" stroke-dasharray="1 0"></line></svg></button>',document.getElementById("id_toolplace_4").innerHTML='Color<input id="id_circle_fill" type="color" class="css-color">'):"rectangle"==type?(dash_array="1 0",document.getElementById("id_toolplace_1").innerHTML='Border Color<input id="id_rectangle_color" type="color" class="css-color">',document.getElementById("id_toolplace_2").innerHTML='Border Width<input id="id_rectangle_width" type="number" value="1" onchange="ChangedNum(\'id_rectangle_width\')" class="css-number">',document.getElementById("id_toolplace_3").innerHTML='<button id="id_datype" class="btn-secondary css-btn-type" data-toggle="modal" data-target="#ModalChooseBorderType"><svg class="css-svg-ln"><line id="id_show_type" x1="10" y1="5" x2="290" y2="5" stroke="white" stroke-width="2" stroke-dasharray="1 0"></line></svg></button>',document.getElementById("id_toolplace_4").innerHTML='Color<input id="id_rectangle_fill" type="color" class="css-color">'):"draw"==type&&(dash_array="1 0",document.getElementById("id_toolplace_1").innerHTML='Color<input id="id_draw_color" type="color" class="css-color">',document.getElementById("id_toolplace_2").innerHTML='Width<input id="id_draw_width" type="number" value="1" onchange="ChangedNum(\'id_draw_width\')" class="css-number">',document.getElementById("id_toolplace_3").innerHTML='<button id="id_datype" class="btn-secondary css-btn-type" data-toggle="modal" data-target="#ModalChooseBorderType"><svg class="css-svg-ln"><line id="id_show_type" x1="10" y1="5" x2="290" y2="5" stroke="white" stroke-width="2" stroke-dasharray="1 0"></line></svg></button>',document.getElementById("id_toolplace_4").innerHTML="")}async function SetUser(e,t){await firebase.database().ref(draw+"/users/"+e).set({canedit:t}),UpdatePupilList()}function _IsDrawing(){return isDrawind||lineDrawind||circleDrawind||rectangleDrawind}async function EmptyPicture(){(await CanEdit()||0!=admin)&&firebase.database().ref().child(draw).child("data").get().then(e=>{if(e.exists()){var t=e.val();firebase.database().ref(draw+"/data").set({creator:t.creator,picture:""})}}).catch(e=>{console.error(e)})}document.getElementById("id_typebtn_cursor").onclick=function(){TitleOfChoosed.innerHTML=document.getElementById("id_typebtn_cursor").innerHTML,type="cursor",UpdateTools()},document.getElementById("id_typebtn_draw").onclick=function(){TitleOfChoosed.innerHTML=document.getElementById("id_typebtn_draw").innerHTML,type="draw",UpdateTools()},document.getElementById("id_typebtn_point").onclick=function(){TitleOfChoosed.innerHTML=document.getElementById("id_typebtn_point").innerHTML,type="point",UpdateTools()},document.getElementById("id_typebtn_line").onclick=function(){TitleOfChoosed.innerHTML=document.getElementById("id_typebtn_line").innerHTML,type="line",UpdateTools()},document.getElementById("id_typebtn_circle").onclick=function(){TitleOfChoosed.innerHTML=document.getElementById("id_typebtn_circle").innerHTML,type="circle",UpdateTools()},document.getElementById("id_typebtn_rectangle").onclick=function(){TitleOfChoosed.innerHTML=document.getElementById("id_typebtn_rectangle").innerHTML,type="rectangle",UpdateTools()},firebase.database().ref(draw).child("data").on("child_changed",function(e){console.log("~changed"),_IsDrawing()||(document.getElementById("id_ge_content").innerHTML=e.val())}),firebase.database().ref(draw).child("data").on("child_added",function(e){console.log("~added"),_IsDrawing()||(document.getElementById("id_ge_content").innerHTML=e.val())}),firebase.database().ref(draw).child("users").child(name).on("child_changed",function(e){can_edit=1==parseInt(e.val())});
